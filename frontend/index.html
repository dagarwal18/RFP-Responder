<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RFP Responder â€” Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #111827;
      --bg-card: rgba(17, 24, 39, 0.8);
      --bg-card-hover: rgba(31, 41, 55, 0.9);
      --border: rgba(75, 85, 99, 0.4);
      --border-accent: rgba(99, 102, 241, 0.5);
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #6366f1;
      --accent-light: #818cf8;
      --accent-glow: rgba(99, 102, 241, 0.15);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* background gradient */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 14, 26, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent-light), var(--success));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      display: inline-block;
      margin-right: 8px;
    }

    .header .api-status {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px 64px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
      }
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      transition: var(--transition);
      overflow: hidden;
    }

    .card:hover {
      border-color: var(--border-accent);
    }

    .card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header h2 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-header .badge {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 20px;
      background: var(--accent-glow);
      color: var(--accent-light);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .card-body {
      padding: 20px 24px;
    }

    /* â”€â”€ Dropzone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .dropzone:hover,
    .dropzone.drag-over {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .dropzone input {
      display: none;
    }

    .dropzone .icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.6;
    }

    .dropzone .label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .dropzone .label strong {
      color: var(--accent-light);
    }

    /* â”€â”€ Select / Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      align-items: center;
    }

    select,
    .btn {
      font-family: inherit;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 8px 14px;
      outline: none;
      transition: var(--transition);
    }

    select:focus {
      border-color: var(--accent);
    }

    .btn {
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #4f46e5 100%);
      border-color: transparent;
      color: #fff;
    }

    .btn-primary:hover {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-outline {
      background: transparent;
    }

    .btn-outline:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--accent);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* â”€â”€ Stats grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .stat-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      text-align: center;
    }

    .stat-box .stat-value {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-light), var(--success));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-box .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* â”€â”€ Query input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .query-row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .query-row input {
      flex: 1;
      font-family: inherit;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 8px 14px;
      outline: none;
    }

    .query-row input:focus {
      border-color: var(--accent);
    }

    /* â”€â”€ Pipeline stepper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pipeline-stepper {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-top: 16px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-left: 2px solid var(--border);
      position: relative;
      transition: var(--transition);
    }

    .step::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-primary);
      flex-shrink: 0;
      transition: var(--transition);
      margin-left: -6px;
    }

    .step.active {
      border-left-color: var(--accent);
    }

    .step.active::before {
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .step.complete {
      border-left-color: var(--success);
    }

    .step.complete::before {
      border-color: var(--success);
      background: var(--success);
    }

    .step.failed {
      border-left-color: var(--error);
    }

    .step.failed::before {
      border-color: var(--error);
      background: var(--error);
    }

    .step-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .step.active .step-label {
      color: var(--text-primary);
    }

    .step.complete .step-label {
      color: var(--success);
    }

    .step.failed .step-label {
      color: var(--error);
    }

    .step-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .log-box {
      margin-top: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.7;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      color: var(--text-secondary);
    }

    .log-box:empty::after {
      content: 'No activity yet...';
      color: var(--text-muted);
      font-style: italic;
    }

    .log-entry {
      display: flex;
      gap: 8px;
    }

    .log-time {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .log-msg {
      word-break: break-word;
    }

    .log-msg.success {
      color: var(--success);
    }

    .log-msg.error {
      color: var(--error);
    }

    .log-msg.info {
      color: var(--info);
    }

    /* â”€â”€ Query results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .query-results {
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .query-result-item {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      background: var(--bg-secondary);
      font-size: 12px;
      line-height: 1.5;
    }

    .query-result-item .score {
      color: var(--accent-light);
      font-weight: 600;
    }

    .query-result-item .text {
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--accent-light);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* fade in */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeUp 0.4s ease-out;
    }

    .card:nth-child(2) {
      animation-delay: 0.1s;
    }

    /* â”€â”€ Runs list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .runs-list {
      margin-top: 16px;
    }

    /* â”€â”€ Auto-classified badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .classified-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .classified-badge.type-capability {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-light);
    }

    .classified-badge.type-past_proposal {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .classified-badge.type-certification {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .classified-badge.type-pricing {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .classified-badge.type-legal {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    /* â”€â”€ Filename display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .file-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .file-info .fname {
      font-weight: 500;
      color: var(--text-primary);
    }

    .file-info .fsize {
      color: var(--text-muted);
    }

    /* â”€â”€ Uploaded files list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kb-files-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .kb-files-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kb-file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      background: var(--bg-secondary);
      font-size: 12px;
    }

    .kb-file-item .kb-file-name {
      font-weight: 500;
      color: var(--text-primary);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kb-file-item .kb-file-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .kb-file-item .kb-file-chunks {
      font-size: 11px;
      color: var(--text-muted);
    }

    .type-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .type-badge.type-capability {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-light);
    }

    .type-badge.type-past_proposal {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .type-badge.type-certification {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .type-badge.type-pricing {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .type-badge.type-legal {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .kb-files-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .run-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      background: var(--bg-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .run-item:hover {
      border-color: var(--accent);
    }

    .run-item .run-id {
      font-size: 13px;
      font-weight: 500;
    }

    .run-item .run-file {
      font-size: 12px;
      color: var(--text-muted);
    }

    .run-item .run-status {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 20px;
    }

    .run-status.INTAKE_COMPLETE {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .run-status.FAILED {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .run-status.RUNNING {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-light);
    }

    .run-status.STRUCTURING {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    /* â”€â”€ Requirement Mappings Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mapping-summary {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .mapping-summary .summary-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .summary-pill .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .mapping-scores {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .mapping-scores .score-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      text-align: center;
      min-width: 120px;
    }

    .score-item .score-val {
      font-size: 24px;
      font-weight: 700;
    }

    .score-item .score-lbl {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .mapping-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .mapping-table thead th {
      padding: 10px 8px;
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 2;
    }

    .mapping-table tbody td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .mapping-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .status-chip {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-chip.ALIGNS {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .status-chip.VIOLATES {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .status-chip.RISK {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .status-chip.NO_MATCH {
      background: rgba(107, 114, 128, 0.15);
      color: #9ca3af;
    }

    .conf-bar {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .conf-bar-track {
      width: 50px;
      height: 5px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 3px;
      overflow: hidden;
    }

    .conf-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.4s ease;
    }

    .conf-bar-val {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 32px;
    }

    .mapping-decision-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      border-radius: 24px;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.5px;
    }

    .mapping-decision-badge.GO {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .mapping-decision-badge.NO_GO {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .mapping-filter-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="header">
    <h1>âš¡ RFP Responder</h1>
    <div class="api-status">
      <span class="status-dot" id="apiDot"></span>
      <span id="apiLabel">Connectingâ€¦</span>
    </div>
  </header>

  <!-- â”€â”€ Main grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="main">

    <!-- â•â•â•â•â•â•â•â•â•â•â• LEFT: Knowledge Base â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card">
      <div class="card-header">
        <h2>ğŸ“š Knowledge Base</h2>
        <span class="badge" id="kbBadge">â€”</span>
      </div>
      <div class="card-body">

        <!-- Upload -->
        <div class="dropzone" id="kbDropzone" onclick="document.getElementById('kbFile').click()">
          <input type="file" id="kbFile" accept=".pdf" />
          <div class="icon">ğŸ“„</div>
          <div class="label">Drop a company doc or <strong>click to browse</strong></div>
        </div>
        <div class="file-info" id="kbFileInfo" style="display:none">
          ğŸ“„ <span class="fname" id="kbFileName"></span>
          <span class="fsize" id="kbFileSize"></span>
        </div>
        <div class="form-row">
          <span id="kbClassifiedType" class="classified-badge" style="display:none"></span>
          <button class="btn btn-primary" id="kbUploadBtn" disabled>
            Upload to KB
          </button>
          <button class="btn btn-outline btn-sm" id="kbSeedBtn">
            ğŸŒ± Seed from JSON
          </button>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="kbStats">
          <div class="stat-box">
            <div class="stat-value" id="kbVectors">â€”</div>
            <div class="stat-label">Vectors</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="kbNamespaces">â€”</div>
            <div class="stat-label">Namespaces</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="kbConfigs">â€”</div>
            <div class="stat-label">Configs</div>
          </div>
        </div>

        <!-- Uploaded Files -->
        <div class="kb-files-header">
          <h3>ğŸ“ Uploaded Documents</h3>
          <button class="btn btn-outline btn-sm" id="kbRefreshFilesBtn"
            style="padding:3px 8px;font-size:11px">ğŸ”„</button>
        </div>
        <div class="kb-files-list" id="kbFilesList">
          <div style="padding:8px;color:var(--text-muted);font-size:12px">No uploads yet.</div>
        </div>

        <!-- Query -->
        <div class="query-row">
          <input type="text" id="kbQueryInput" placeholder="Test query against knowledge baseâ€¦" />
          <select id="kbQueryType" style="width:auto;min-width:90px">
            <option value="">All Types</option>
            <option value="capability">Capability</option>
            <option value="past_proposal">Past Proposal</option>
            <option value="certification">Certification</option>
            <option value="pricing">Pricing</option>
            <option value="legal">Legal</option>
          </select>
          <button class="btn btn-outline btn-sm" id="kbQueryBtn">ğŸ” Query</button>
        </div>
        <div class="query-results" id="kbQueryResults"></div>

        <!-- Log -->
        <div class="log-box" id="kbLog"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• RIGHT: RFP Pipeline â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card">
      <div class="card-header">
        <h2>ğŸš€ RFP Pipeline</h2>
        <span class="badge" id="rfpBadge">Ready</span>
      </div>
      <div class="card-body">

        <!-- Upload -->
        <div class="dropzone" id="rfpDropzone" onclick="document.getElementById('rfpFile').click()">
          <input type="file" id="rfpFile" accept=".pdf" />
          <div class="icon">ğŸ“‘</div>
          <div class="label">Drop an RFP document or <strong>click to browse</strong></div>
        </div>
        <div class="file-info" id="rfpFileInfo" style="display:none">
          ğŸ“‘ <span class="fname" id="rfpFileName"></span>
          <span class="fsize" id="rfpFileSize"></span>
        </div>
        <div class="form-row">
          <button class="btn btn-primary" id="rfpUploadBtn" disabled>
            Run Pipeline
          </button>
          <button class="btn btn-outline btn-sm" id="rfpRefreshBtn">
            ğŸ”„ Refresh Runs
          </button>
        </div>

        <!-- Pipeline progress -->
        <div class="pipeline-stepper" id="pipelineStepper">
          <!-- steps injected by JS -->
        </div>

        <!-- Recent runs -->
        <div class="runs-list" id="runsList"></div>

        <!-- Log -->
        <div class="log-box" id="rfpLog"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  COMPANY POLICIES PANEL                             -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card" style="margin-top:20px">
      <div class="card-header">
        <h2>ğŸ“œ Company Policies</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="policyCategoryFilter"
            style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:12px">
            <option value="">All Categories</option>
            <option value="certification">Certification</option>
            <option value="legal">Legal</option>
            <option value="compliance">Compliance</option>
            <option value="operational">Operational</option>
            <option value="commercial">Commercial</option>
            <option value="governance">Governance</option>
            <option value="capability">Capability</option>
          </select>
          <button class="btn btn-primary btn-sm" id="addPolicyBtn">+ Add Policy</button>
          <button class="btn btn-outline btn-sm" id="deleteAllPoliciesBtn" style="color:#ef4444;border-color:#ef4444">ğŸ—‘
            Delete All</button>
        </div>
      </div>
      <div class="card-body">
        <div id="policiesContainer" style="max-height:400px;overflow-y:auto">
          <table style="width:100%;border-collapse:collapse;font-size:13px" id="policiesTable">
            <thead>
              <tr style="text-align:left;border-bottom:1px solid var(--border)">
                <th style="padding:8px 6px;width:40%">Policy</th>
                <th style="padding:8px 6px">Category</th>
                <th style="padding:8px 6px">Severity</th>
                <th style="padding:8px 6px">Source</th>
                <th style="padding:8px 6px;width:100px">Actions</th>
              </tr>
            </thead>
            <tbody id="policiesTableBody">
              <tr>
                <td colspan="5" style="padding:16px;text-align:center;color:var(--text-muted)">Loading policiesâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  ADD/EDIT POLICY MODAL                              -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="policyModal"
      style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
      <div
        style="background:var(--card-bg);border-radius:12px;padding:24px;max-width:500px;width:90%;border:1px solid var(--border)">
        <h3 id="policyModalTitle" style="margin:0 0 16px">Add Policy</h3>
        <input type="hidden" id="policyEditId" />
        <div style="display:flex;flex-direction:column;gap:10px">
          <textarea id="policyTextInput" rows="3" placeholder="Policy textâ€¦"
            style="padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:13px;resize:vertical"></textarea>
          <div style="display:flex;gap:8px">
            <select id="policyCatInput"
              style="flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:12px">
              <option value="capability">Capability</option>
              <option value="certification">Certification</option>
              <option value="legal">Legal</option>
              <option value="compliance">Compliance</option>
              <option value="operational">Operational</option>
              <option value="commercial">Commercial</option>
              <option value="governance">Governance</option>
            </select>
            <select id="policySevInput"
              style="flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:12px">
              <option value="medium">Medium</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="low">Low</option>
            </select>
          </div>
          <input id="policySectionInput" placeholder="Source section (optional)"
            style="padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:13px" />
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-outline btn-sm" onclick="closePolicyModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" id="policySaveBtn" onclick="savePolicy()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  REQUIREMENT MAPPINGS                               -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card" style="margin-top:20px" id="mappingsCard">
      <div class="card-header">
        <h2>ğŸ“‹ Requirement Mappings</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <span style="font-size:12px;color:var(--text-muted)" id="mappingsHint">Run a pipeline or select a completed
            run</span>
          <span class="mapping-decision-badge" id="mappingDecisionBadge" style="display:none"></span>
        </div>
      </div>
      <div class="card-body">
        <div id="mappingsContainer">
          <div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">
            No requirement mappings available. Upload an RFP and run the pipeline to see how each requirement maps to
            your company policies.
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  EXTRACTED REQUIREMENTS (B1 + B2)                   -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card" style="margin-top:20px" id="requirementsCard">
      <div class="card-header">
        <h2>ğŸ“ Extracted Requirements</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <span style="font-size:12px;color:var(--text-muted)" id="reqsHint">Select a completed run to view</span>
          <span id="reqConfBadge"
            style="display:none;font-size:12px;font-weight:600;padding:3px 10px;border-radius:20px;border:1px solid"></span>
        </div>
      </div>
      <div class="card-body">
        <!-- Stats row -->
        <div id="reqsStats" style="display:none;margin-bottom:16px">
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
            <div class="stat-box">
              <div class="stat-value" id="reqTotal">0</div>
              <div class="stat-label">Total</div>
            </div>
            <div class="stat-box">
              <div class="stat-value"
                style="background:linear-gradient(135deg,#6366f1,#818cf8);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent"
                id="reqFunctional">0</div>
              <div class="stat-label">Functional</div>
            </div>
            <div class="stat-box">
              <div class="stat-value"
                style="background:linear-gradient(135deg,#10b981,#34d399);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent"
                id="reqNonFunctional">0</div>
              <div class="stat-label">Non-Functional</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="reqDuplicates" style="color:var(--warning)">0</div>
              <div class="stat-label">Duplicates</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="reqIssues" style="color:var(--error)">0</div>
              <div class="stat-label">Issues</div>
            </div>
          </div>
        </div>
        <!-- Filter row -->
        <div id="reqsFilterRow" style="display:none;margin-bottom:12px;display:flex;gap:10px;align-items:center">
          <select id="reqClassFilter"
            style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-size:12px">
            <option value="">All Classifications</option>
            <option value="FUNCTIONAL">Functional</option>
            <option value="NON_FUNCTIONAL">Non-Functional</option>
          </select>
          <select id="reqTypeFilter"
            style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-size:12px">
            <option value="">All Types</option>
            <option value="MANDATORY">Mandatory</option>
            <option value="OPTIONAL">Optional</option>
          </select>
          <span style="font-size:11px;color:var(--text-muted)" id="reqFilterCount"></span>
        </div>
        <div id="reqsContainer">
          <div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">No requirements loaded.
            Click a pipeline run to view extracted requirements.</div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  AGENT OUTPUT LOGS                                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card" style="margin-top:20px">
      <div class="card-header">
        <h2>ğŸ¤– Agent Output Logs</h2>
        <span style="font-size:12px;color:var(--text-muted)" id="agentLogsHint">Select a completed pipeline run to view
          agent outputs</span>
      </div>
      <div class="card-body">
        <div id="agentLogsContainer">
          <div style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px">
            No agent logs loaded. Click a pipeline run above to view its agent outputs.
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API = 'http://localhost:8000';
    const WS_BASE = API.replace(/^http/, 'ws');

    // â”€â”€ Pipeline stages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STAGES = [
      { key: 'A1_INTAKE', label: 'A1 â€” Intake', status: 'INTAKE_COMPLETE' },
      { key: 'A2_STRUCTURING', label: 'A2 â€” Structuring', status: 'STRUCTURING' },
      { key: 'A3_GO_NO_GO', label: 'A3 â€” Go / No-Go', status: 'GO_NO_GO' },
      { key: 'B1_REQUIREMENTS_EXTRACTION', label: 'B1 â€” Requirement Extract', status: 'EXTRACTING_REQUIREMENTS' },
      { key: 'B2_REQUIREMENTS_VALIDATION', label: 'B2 â€” Requirement Valid.', status: 'VALIDATING_REQUIREMENTS' },
      { key: 'C1_ARCHITECTURE_PLANNING', label: 'C1 â€” Architecture Plan', status: 'ARCHITECTURE_PLANNING' },
      { key: 'C2_REQUIREMENT_WRITING', label: 'C2 â€” Response Writing', status: 'WRITING_RESPONSES' },
      { key: 'C3_NARRATIVE_ASSEMBLY', label: 'C3 â€” Narrative Assembly', status: 'ASSEMBLING_NARRATIVE' },
      { key: 'D1_TECHNICAL_VALIDATION', label: 'D1 â€” Technical Validation', status: 'TECHNICAL_VALIDATION' },
      { key: 'E1_COMMERCIAL', label: 'E1 â€” Commercial Review', status: 'COMMERCIAL_LEGAL_REVIEW' },
      { key: 'E2_LEGAL', label: 'E2 â€” Legal Review', status: 'COMMERCIAL_LEGAL_REVIEW' },
      { key: 'F1_FINAL_READINESS', label: 'F1 â€” Final Readiness', status: 'FINAL_READINESS' },
      { key: 'F2_SUBMISSION', label: 'F2 â€” Submission', status: 'SUBMITTED' },
    ];

    // â”€â”€ Stepper state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Maps stage key â†’ 'pending' | 'active' | 'complete' | 'failed'
    let stepperState = {};
    function resetStepperState() {
      stepperState = {};
      STAGES.forEach(s => stepperState[s.key] = 'pending');
    }
    resetStepperState();

    // â”€â”€ Helper: format file size â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // â”€â”€ Helper: log to a log-box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addLog(boxId, msg, cls = '') {
      const box = document.getElementById(boxId);
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg ${cls}">${msg}</span>`;
      box.appendChild(entry);
      box.scrollTop = box.scrollHeight;
    }

    // â”€â”€ Helper: fetch with error handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function apiFetch(path, opts = {}) {
      try {
        const res = await fetch(`${API}${path}`, opts);
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || res.statusText);
        }
        return await res.json();
      } catch (e) {
        throw e;
      }
    }

    // â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkHealth() {
      const dot = document.getElementById('apiDot');
      const label = document.getElementById('apiLabel');
      try {
        await apiFetch('/health');
        dot.style.background = 'var(--success)';
        dot.style.boxShadow = '0 0 8px var(--success)';
        label.textContent = 'API Connected';
      } catch {
        dot.style.background = 'var(--error)';
        dot.style.boxShadow = '0 0 8px var(--error)';
        label.textContent = 'API Offline';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  KNOWLEDGE BASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const kbFile = document.getElementById('kbFile');
    const kbUploadBtn = document.getElementById('kbUploadBtn');
    const kbDropzone = document.getElementById('kbDropzone');
    const kbFileInfo = document.getElementById('kbFileInfo');

    function showKBFile(file) {
      document.getElementById('kbFileName').textContent = file.name;
      document.getElementById('kbFileSize').textContent = `(${formatSize(file.size)})`;
      kbFileInfo.style.display = 'flex';
    }

    function hideKBFile() {
      kbFileInfo.style.display = 'none';
    }

    kbFile.addEventListener('change', () => {
      kbUploadBtn.disabled = !kbFile.files.length;
      if (kbFile.files.length) {
        showKBFile(kbFile.files[0]);
        kbDropzone.querySelector('.label').innerHTML =
          `<strong>${kbFile.files[0].name}</strong> selected`;
      } else {
        hideKBFile();
      }
    });

    // Drag & drop
    kbDropzone.addEventListener('dragover', e => { e.preventDefault(); kbDropzone.classList.add('drag-over'); });
    kbDropzone.addEventListener('dragleave', () => kbDropzone.classList.remove('drag-over'));
    kbDropzone.addEventListener('drop', e => {
      e.preventDefault(); kbDropzone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        kbFile.files = e.dataTransfer.files;
        kbFile.dispatchEvent(new Event('change'));
      }
    });

    // Upload â€” no doc_type sent â‡’ backend auto-classifies
    kbUploadBtn.addEventListener('click', async () => {
      const file = kbFile.files[0];
      if (!file) return;

      const typeBadge = document.getElementById('kbClassifiedType');
      typeBadge.style.display = 'none';

      kbUploadBtn.disabled = true;
      kbUploadBtn.innerHTML = '<span class="spinner"></span> Uploadingâ€¦';
      addLog('kbLog', `Uploading ${file.name} â€” auto-classifyingâ€¦`, 'info');

      // Pause background polling so it doesn't compete with the upload
      pausePolling();

      const form = new FormData();
      form.append('file', file);
      // No doc_type â†’ backend auto-classifies

      try {
        const data = await apiFetch('/api/knowledge/upload', { method: 'POST', body: form });

        // Show auto-classified type badge
        const classLabel = data.auto_classified ? `Auto: ${data.doc_type}` : data.doc_type;
        typeBadge.textContent = classLabel;
        typeBadge.className = `classified-badge type-${data.doc_type}`;
        typeBadge.style.display = 'inline-block';

        addLog('kbLog', `âœ“ ${data.message}`, 'success');
        if (data.auto_classified) {
          addLog('kbLog', `ğŸ“‹ Auto-classified as "${data.doc_type}"`, 'info');
        }
        loadKBStats();
        loadKBFiles();
      } catch (e) {
        addLog('kbLog', `âœ— Upload failed: ${e.message}`, 'error');
      } finally {
        kbUploadBtn.innerHTML = 'Upload to KB';
        kbUploadBtn.disabled = false;
        kbFile.value = '';
        kbDropzone.querySelector('.label').innerHTML =
          'Drop a company doc or <strong>click to browse</strong>';
        hideKBFile();
        resumePolling();
      }
    });

    // Seed
    document.getElementById('kbSeedBtn').addEventListener('click', async () => {
      const btn = document.getElementById('kbSeedBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Seedingâ€¦';
      addLog('kbLog', 'Seeding knowledge base from JSON filesâ€¦', 'info');
      pausePolling();

      try {
        const data = await apiFetch('/api/knowledge/seed', { method: 'POST' });
        addLog('kbLog', `âœ“ ${data.message}`, 'success');
        loadKBStats();
      } catch (e) {
        addLog('kbLog', `âœ— Seed failed: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸŒ± Seed from JSON';
        resumePolling();
      }
    });

    // Stats
    async function loadKBStats() {
      try {
        const data = await apiFetch('/api/knowledge/status');
        document.getElementById('kbVectors').textContent = data.pinecone.total_vectors ?? 'â€”';
        const nsCount = data.pinecone.namespaces ? Object.keys(data.pinecone.namespaces).length : 0;
        document.getElementById('kbNamespaces').textContent = nsCount;
        document.getElementById('kbConfigs').textContent =
          data.mongodb.configs ? data.mongodb.configs.length : 0;
        document.getElementById('kbBadge').textContent =
          `${data.pinecone.total_vectors ?? 0} vectors`;
      } catch {
        document.getElementById('kbBadge').textContent = 'Offline';
      }
    }

    // Query â€” with optional doc_type filter
    document.getElementById('kbQueryBtn').addEventListener('click', async () => {
      const q = document.getElementById('kbQueryInput').value.trim();
      if (!q) return;
      const docType = document.getElementById('kbQueryType').value;
      const box = document.getElementById('kbQueryResults');
      box.innerHTML = '<div style="padding:8px;color:var(--text-muted)"><span class="spinner"></span> Queryingâ€¦</div>';

      try {
        const payload = { query: q, top_k: 5 };
        if (docType) payload.doc_type = docType;

        const data = await apiFetch('/api/knowledge/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!data.results.length) {
          box.innerHTML = '<div style="padding:8px;color:var(--text-muted)">No results.</div>';
          return;
        }
        box.innerHTML = data.results.map(r => `
          <div class="query-result-item">
            <span class="score">[${(r.score || 0).toFixed(3)}]</span>
            ${r.id || ''}
            <div class="text">${(r.text || '').substring(0, 200)}â€¦</div>
          </div>
        `).join('');
      } catch (e) {
        box.innerHTML = `<div style="padding:8px;color:var(--error)">Query failed: ${e.message}</div>`;
      }
    });

    // â”€â”€ Uploaded KB files list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadKBFiles() {
      try {
        const files = await apiFetch('/api/knowledge/files');
        const box = document.getElementById('kbFilesList');
        if (!files.length) {
          box.innerHTML = '<div style="padding:8px;color:var(--text-muted);font-size:12px">No uploads yet.</div>';
          return;
        }
        box.innerHTML = files.map(f => {
          const autoTag = f.auto_classified ? ' (auto)' : '';
          return `
            <div class="kb-file-item">
              <span class="kb-file-name" title="${f.filename}">ğŸ“„ ${f.filename}</span>
              <div class="kb-file-meta">
                <span class="kb-file-chunks">${f.chunks_stored} chunks</span>
                <span class="type-badge type-${f.doc_type}">${f.doc_type}${autoTag}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch {
        // silently ignore
      }
    }

    document.getElementById('kbRefreshFilesBtn').addEventListener('click', loadKBFiles);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RFP PIPELINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const rfpFile = document.getElementById('rfpFile');
    const rfpUploadBtn = document.getElementById('rfpUploadBtn');
    const rfpDropzone = document.getElementById('rfpDropzone');
    const rfpFileInfo = document.getElementById('rfpFileInfo');
    let activeWS = null;
    let activeRfpId = null;

    function showRFPFile(file) {
      document.getElementById('rfpFileName').textContent = file.name;
      document.getElementById('rfpFileSize').textContent = `(${formatSize(file.size)})`;
      rfpFileInfo.style.display = 'flex';
    }

    function hideRFPFile() {
      rfpFileInfo.style.display = 'none';
    }

    rfpFile.addEventListener('change', () => {
      rfpUploadBtn.disabled = !rfpFile.files.length;
      if (rfpFile.files.length) {
        showRFPFile(rfpFile.files[0]);
        rfpDropzone.querySelector('.label').innerHTML =
          `<strong>${rfpFile.files[0].name}</strong> selected`;
      } else {
        hideRFPFile();
      }
    });

    rfpDropzone.addEventListener('dragover', e => { e.preventDefault(); rfpDropzone.classList.add('drag-over'); });
    rfpDropzone.addEventListener('dragleave', () => rfpDropzone.classList.remove('drag-over'));
    rfpDropzone.addEventListener('drop', e => {
      e.preventDefault(); rfpDropzone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        rfpFile.files = e.dataTransfer.files;
        rfpFile.dispatchEvent(new Event('change'));
      }
    });

    // Build pipeline stepper from stepperState
    function renderStepper() {
      const box = document.getElementById('pipelineStepper');
      box.innerHTML = STAGES.map(s => {
        const state = stepperState[s.key] || 'pending';
        let cls = '';
        if (state === 'active') cls = 'active';
        if (state === 'complete') cls = 'complete';
        if (state === 'failed') cls = 'failed';
        return `<div class="step ${cls}"><div><div class="step-label">${s.label}</div></div></div>`;
      }).join('');
    }
    renderStepper(); // initial empty

    // â”€â”€ WebSocket connection for real-time progress â”€â”€â”€â”€â”€
    function connectPipelineWS(rfpId) {
      // Close any existing connection
      if (activeWS) {
        try { activeWS.close(); } catch { }
      }
      activeRfpId = rfpId;

      const url = `${WS_BASE}/api/rfp/ws/${rfpId}`;
      addLog('rfpLog', `Connecting to live progressâ€¦`, 'info');
      const ws = new WebSocket(url);
      activeWS = ws;

      ws.onopen = () => {
        addLog('rfpLog', `ğŸ”— Live progress connected`, 'info');
      };

      ws.onmessage = (evt) => {
        let data;
        try { data = JSON.parse(evt.data); } catch { return; }

        switch (data.event) {
          case 'node_start':
            stepperState[data.agent] = 'active';
            addLog('rfpLog', `â–¶ Starting ${data.agent}`, 'info');
            renderStepper();
            break;

          case 'node_end':
            stepperState[data.agent] = 'complete';
            addLog('rfpLog', `âœ“ ${data.agent} â†’ ${data.status || 'done'}`, 'success');
            renderStepper();
            break;

          case 'error':
            stepperState[data.agent] = 'failed';
            addLog('rfpLog', `âœ— ${data.agent}: ${data.message}`, 'error');
            renderStepper();
            break;

          case 'pipeline_end':
            const endStatus = data.status || 'UNKNOWN';
            document.getElementById('rfpBadge').textContent = endStatus;
            addLog('rfpLog', `â•â• Pipeline finished: ${endStatus}`,
              endStatus === 'FAILED' ? 'error' : 'success');

            // Re-enable upload button
            rfpUploadBtn.innerHTML = 'Run Pipeline';
            rfpUploadBtn.disabled = false;

            // Refresh runs list, load mappings, and load requirements
            loadRuns();
            if (activeRfpId) loadMappings(activeRfpId);
            if (activeRfpId) loadRequirements(activeRfpId);
            break;
        }
      };

      ws.onclose = () => {
        addLog('rfpLog', `WebSocket closed`, '');
        if (activeWS === ws) activeWS = null;
      };

      ws.onerror = () => {
        addLog('rfpLog', `WebSocket error â€” falling back to polling`, 'error');
        if (activeWS === ws) activeWS = null;
        // Fallback: poll status until done
        startPolling(rfpId);
      };
    }

    // â”€â”€ Polling fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startPolling(rfpId) {
      const interval = setInterval(async () => {
        try {
          const status = await apiFetch(`/api/rfp/${rfpId}/status`);
          if (status.status !== 'RUNNING') {
            clearInterval(interval);
            document.getElementById('rfpBadge').textContent = status.status;
            updateStepperFromStatus(status);
            rfpUploadBtn.innerHTML = 'Run Pipeline';
            rfpUploadBtn.disabled = false;
            loadRuns();
          }
        } catch {
          clearInterval(interval);
        }
      }, 2000);
    }

    // â”€â”€ Update stepper from a status response (for polling/viewRun) â”€â”€
    function updateStepperFromStatus(status) {
      resetStepperState();
      const currentAgent = status.current_agent || '';
      const failed = status.status === 'FAILED';
      let hitCurrent = false;

      for (const s of STAGES) {
        if (s.key === currentAgent) {
          stepperState[s.key] = failed ? 'failed' : 'active';
          hitCurrent = true;
        } else if (!hitCurrent && currentAgent) {
          stepperState[s.key] = 'complete';
        }
      }
      renderStepper();
    }

    // Upload & run pipeline (returns immediately, progress via WS)
    rfpUploadBtn.addEventListener('click', async () => {
      const file = rfpFile.files[0];
      if (!file) return;

      rfpUploadBtn.disabled = true;
      rfpUploadBtn.innerHTML = '<span class="spinner"></span> Startingâ€¦';
      document.getElementById('rfpBadge').textContent = 'Running';
      addLog('rfpLog', `Uploading ${file.name}â€¦`, 'info');

      // Reset stepper for a new run
      resetStepperState();
      renderStepper();

      const form = new FormData();
      form.append('file', file);

      try {
        const data = await apiFetch('/api/rfp/upload', { method: 'POST', body: form });
        addLog('rfpLog', `Pipeline started â†’ ${data.rfp_id}`, 'info');
        document.getElementById('rfpBadge').textContent = 'Running';

        // Keep filename visible during pipeline execution
        rfpUploadBtn.innerHTML = '<span class="spinner"></span> Runningâ€¦';

        // Connect WebSocket for live progress
        connectPipelineWS(data.rfp_id);

        // Clear file input but keep filename info visible
        rfpFile.value = '';
        rfpDropzone.querySelector('.label').innerHTML =
          'Drop an RFP document or <strong>click to browse</strong>';

      } catch (e) {
        addLog('rfpLog', `âœ— Upload failed: ${e.message}`, 'error');
        document.getElementById('rfpBadge').textContent = 'Failed';
        rfpUploadBtn.innerHTML = 'Run Pipeline';
        rfpUploadBtn.disabled = false;
      }
    });

    // Load runs list
    async function loadRuns() {
      try {
        const data = await apiFetch('/api/rfp/list');
        const box = document.getElementById('runsList');
        if (!data.length) {
          box.innerHTML = '<div style="padding:8px;color:var(--text-muted);font-size:13px">No pipeline runs yet.</div>';
          return;
        }
        box.innerHTML = data.map(r => `
          <div class="run-item" onclick="viewRun('${r.rfp_id}')">
            <div>
              <div class="run-id">${r.rfp_id}</div>
              <div class="run-file">${r.filename || 'â€”'}</div>
            </div>
            <div class="run-status ${r.status}">${r.status}</div>
          </div>
        `).join('');
      } catch { }
    }

    async function viewRun(rfpId) {
      try {
        const status = await apiFetch(`/api/rfp/${rfpId}/status`);
        document.getElementById('rfpBadge').textContent = status.status;
        addLog('rfpLog', `Viewing run ${rfpId}: ${status.status}`, 'info');

        updateStepperFromStatus(status);

        // Load agent output logs
        loadAgentLogs(rfpId);

        // Load requirement mappings
        loadMappings(rfpId);

        // Load extracted requirements
        loadRequirements(rfpId);

        // If it's still running, connect the WebSocket
        if (status.status === 'RUNNING') {
          connectPipelineWS(rfpId);
        }
      } catch (e) {
        addLog('rfpLog', `Failed to load run: ${e.message}`, 'error');
      }
    }

    document.getElementById('rfpRefreshBtn').addEventListener('click', loadRuns);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  COMPANY POLICIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadPolicies() {
      const category = document.getElementById('policyCategoryFilter').value;
      const qs = category ? `?category=${category}` : '';
      try {
        const data = await apiFetch(`/api/knowledge/policies${qs}`);
        const tbody = document.getElementById('policiesTableBody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:var(--text-muted)">No policies extracted yet. Upload a company document to extract policies.</td></tr>';
          return;
        }
        const sevColors = { critical: '#ef4444', high: '#f97316', medium: '#eab308', low: '#22c55e' };
        tbody.innerHTML = data.map(p => `
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px 6px;max-width:300px;overflow:hidden;text-overflow:ellipsis" title="${(p.policy_text || '').replace(/"/g, '&quot;')}">${p.policy_text || ''}</td>
            <td style="padding:8px 6px"><span class="type-badge">${p.category || ''}</span></td>
            <td style="padding:8px 6px"><span style="color:${sevColors[p.severity] || '#888'};font-weight:600;font-size:12px">${(p.severity || '').toUpperCase()}</span></td>
            <td style="padding:8px 6px;font-size:12px;color:var(--text-muted)" title="${p.source_filename || ''}">${(p.source_filename || 'manual').substring(0, 20)}</td>
            <td style="padding:8px 6px">
              <button class="btn btn-outline btn-sm" style="font-size:11px;padding:2px 8px;margin-right:4px" onclick="editPolicy('${p.policy_id}')">âœï¸</button>
              <button class="btn btn-outline btn-sm" style="font-size:11px;padding:2px 8px;color:#ef4444" onclick="deletePolicy('${p.policy_id}')">ğŸ—‘</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        document.getElementById('policiesTableBody').innerHTML = `<tr><td colspan="5" style="padding:16px;text-align:center;color:#ef4444">Failed to load policies: ${e.message}</td></tr>`;
      }
    }

    function openPolicyModal(title = 'Add Policy', policy = null) {
      document.getElementById('policyModalTitle').textContent = title;
      document.getElementById('policyEditId').value = policy ? policy.policy_id : '';
      document.getElementById('policyTextInput').value = policy ? policy.policy_text : '';
      document.getElementById('policyCatInput').value = policy ? policy.category : 'capability';
      document.getElementById('policySevInput').value = policy ? policy.severity : 'medium';
      document.getElementById('policySectionInput').value = policy ? (policy.source_section || '') : '';
      const modal = document.getElementById('policyModal');
      modal.style.display = 'flex';
    }
    window.closePolicyModal = function () {
      document.getElementById('policyModal').style.display = 'none';
    };

    document.getElementById('addPolicyBtn').addEventListener('click', () => openPolicyModal());

    window.savePolicy = async function () {
      const editId = document.getElementById('policyEditId').value;
      const body = {
        policy_text: document.getElementById('policyTextInput').value.trim(),
        category: document.getElementById('policyCatInput').value,
        severity: document.getElementById('policySevInput').value,
        source_section: document.getElementById('policySectionInput').value.trim(),
      };
      if (!body.policy_text) return alert('Policy text is required');
      try {
        if (editId) {
          await apiFetch(`/api/knowledge/policies/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
        } else {
          await apiFetch('/api/knowledge/policies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
        }
        closePolicyModal();
        loadPolicies();
      } catch (e) {
        alert('Failed to save: ' + e.message);
      }
    };

    window.editPolicy = async function (policyId) {
      try {
        const policies = await apiFetch('/api/knowledge/policies');
        const pol = policies.find(p => p.policy_id === policyId);
        if (pol) openPolicyModal('Edit Policy', pol);
      } catch (e) {
        alert('Failed to load policy: ' + e.message);
      }
    };

    window.deletePolicy = async function (policyId) {
      if (!confirm(`Delete policy ${policyId}?`)) return;
      try {
        await apiFetch(`/api/knowledge/policies/${policyId}`, { method: 'DELETE' });
        loadPolicies();
      } catch (e) {
        alert('Failed to delete: ' + e.message);
      }
    };

    document.getElementById('policyCategoryFilter').addEventListener('change', loadPolicies);

    document.getElementById('deleteAllPoliciesBtn').addEventListener('click', async () => {
      if (!confirm('Delete ALL policies? This cannot be undone.')) return;
      try {
        const res = await apiFetch('/api/knowledge/policies', { method: 'DELETE' });
        alert(res.message || 'All policies deleted');
        loadPolicies();
      } catch (e) {
        alert('Failed to delete policies: ' + e.message);
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  REQUIREMENT MAPPINGS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadMappings(rfpId) {
      const container = document.getElementById('mappingsContainer');
      const badge = document.getElementById('mappingDecisionBadge');
      const hint = document.getElementById('mappingsHint');
      container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted)"><span class="spinner"></span> Loading mappingsâ€¦</div>';
      hint.textContent = `Run: ${rfpId}`;
      badge.style.display = 'none';

      try {
        const data = await apiFetch(`/api/rfp/${rfpId}/mappings`);
        if (!data.available) {
          container.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">${data.message || 'No mapping data available.'}</div>`;
          return;
        }

        // Decision badge
        badge.textContent = data.decision === 'GO' ? 'âœ… GO' : 'âŒ NO GO';
        badge.className = `mapping-decision-badge ${data.decision}`;
        badge.style.display = 'inline-flex';

        // Build HTML
        let html = '';

        // â”€â”€ Scores row â”€â”€
        const sc = data.scores || {};
        const scoreColor = (val, invert) => {
          const v = parseFloat(val) || 0;
          if (invert) return v > 7 ? '#ef4444' : v > 4 ? '#f59e0b' : '#10b981';
          return v >= 7 ? '#10b981' : v >= 4 ? '#f59e0b' : '#ef4444';
        };
        html += `<div class="mapping-scores">
          <div class="score-item"><div class="score-val" style="color:${scoreColor(sc.strategic_fit)}">${(sc.strategic_fit || 0).toFixed(1)}</div><div class="score-lbl">Strategic Fit</div></div>
          <div class="score-item"><div class="score-val" style="color:${scoreColor(sc.technical_feasibility)}">${(sc.technical_feasibility || 0).toFixed(1)}</div><div class="score-lbl">Technical</div></div>
          <div class="score-item"><div class="score-val" style="color:${scoreColor(sc.regulatory_risk, true)}">${(sc.regulatory_risk || 0).toFixed(1)}</div><div class="score-lbl">Reg. Risk</div></div>
        </div>`;

        // â”€â”€ Justification â”€â”€
        if (data.justification) {
          html += `<div style="margin-bottom:14px;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;font-size:13px">
            <strong>Justification:</strong> ${data.justification}
          </div>`;
        }

        // â”€â”€ Red flags & violations â”€â”€
        if (data.red_flags && data.red_flags.length) {
          html += `<div style="margin-bottom:10px;padding:8px 14px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:12px;color:#f59e0b">
            <strong>âš  Red Flags:</strong> ${data.red_flags.join(' â€¢ ')}
          </div>`;
        }
        if (data.policy_violations && data.policy_violations.length) {
          html += `<div style="margin-bottom:10px;padding:8px 14px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:12px;color:#ef4444">
            <strong>âŒ Policy Violations:</strong> ${data.policy_violations.join(' â€¢ ')}
          </div>`;
        }

        // â”€â”€ Summary pills â”€â”€
        const sm = data.summary || {};
        html += `<div class="mapping-summary">
          <div class="summary-pill"><span class="pill-dot" style="background:#6366f1"></span> ${sm.total || 0} Total</div>
          <div class="summary-pill"><span class="pill-dot" style="background:#10b981"></span> ${sm.aligned || 0} Aligned</div>
          <div class="summary-pill"><span class="pill-dot" style="background:#ef4444"></span> ${sm.violated || 0} Violated</div>
          <div class="summary-pill"><span class="pill-dot" style="background:#f59e0b"></span> ${sm.risk || 0} Risk</div>
          <div class="summary-pill"><span class="pill-dot" style="background:#9ca3af"></span> ${sm.no_match || 0} No Match</div>
        </div>`;

        // â”€â”€ Filter row â”€â”€
        html += `<div class="mapping-filter-row">
          <select id="mappingStatusFilter" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-size:12px">
            <option value="">All Statuses</option>
            <option value="ALIGNS">âœ… Aligns</option>
            <option value="VIOLATES">âŒ Violates</option>
            <option value="RISK">âš ï¸ Risk</option>
            <option value="NO_MATCH">â“ No Match</option>
          </select>
          <span style="font-size:11px;color:var(--text-muted)" id="mappingFilterCount">${(data.mappings || []).length} mappings</span>
        </div>`;

        // â”€â”€ Table â”€â”€
        const mappings = data.mappings || [];
        html += `<div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px">
          <table class="mapping-table" id="mappingTable">
            <thead>
              <tr>
                <th style="width:100px">ID</th>
                <th style="width:90px">Status</th>
                <th style="width:75px">Confidence</th>
                <th>Requirement</th>
                <th>Matched Policy</th>
                <th>Reasoning</th>
              </tr>
            </thead>
            <tbody>
              ${mappings.map(m => {
          const conf = parseFloat(m.confidence) || 0;
          const confColor = conf >= 0.8 ? '#10b981' : conf >= 0.5 ? '#f59e0b' : '#ef4444';
          return `<tr data-status="${m.mapping_status}">
                  <td style="font-weight:500;font-size:11px;color:var(--accent-light)">${m.requirement_id || 'â€”'}</td>
                  <td><span class="status-chip ${m.mapping_status}">${m.mapping_status}</span></td>
                  <td>
                    <div class="conf-bar">
                      <div class="conf-bar-track"><div class="conf-bar-fill" style="width:${conf * 100}%;background:${confColor}"></div></div>
                      <span class="conf-bar-val">${(conf * 100).toFixed(0)}%</span>
                    </div>
                  </td>
                  <td style="max-width:220px;line-height:1.4" title="${(m.requirement_text || '').replace(/"/g, '&quot;')}">${m.requirement_text || 'â€”'}</td>
                  <td style="font-size:11px;max-width:180px;line-height:1.4;color:var(--text-secondary)" title="${(m.matched_policy || '').replace(/"/g, '&quot;')}">${m.matched_policy || 'â€”'}</td>
                  <td style="font-size:11px;max-width:180px;line-height:1.4;color:var(--text-muted)">${m.reasoning || 'â€”'}</td>
                </tr>`;
        }).join('')}
            </tbody>
          </table>
        </div>`;

        container.innerHTML = html;

        // â”€â”€ Wire up filter â”€â”€
        const filterSelect = document.getElementById('mappingStatusFilter');
        if (filterSelect) {
          filterSelect.addEventListener('change', () => {
            const val = filterSelect.value;
            const rows = document.querySelectorAll('#mappingTable tbody tr');
            let visible = 0;
            rows.forEach(row => {
              const show = !val || row.dataset.status === val;
              row.style.display = show ? '' : 'none';
              if (show) visible++;
            });
            document.getElementById('mappingFilterCount').textContent = `${visible} mappings`;
          });
        }

      } catch (e) {
        container.innerHTML = `<div style="padding:24px;text-align:center;color:#ef4444;font-size:13px">Failed to load mappings: ${e.message}</div>`;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AGENT OUTPUT LOGS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadAgentLogs(rfpId) {
      const container = document.getElementById('agentLogsContainer');
      container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted)">Loading agent outputsâ€¦</div>';
      document.getElementById('agentLogsHint').textContent = `Run: ${rfpId}`;
      try {
        const status = await apiFetch(`/api/rfp/${rfpId}/status`);
        const outputs = status.agent_outputs || {};
        if (!Object.keys(outputs).length) {
          container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted)">No agent outputs available for this run.</div>';
          return;
        }
        let html = '';
        // A1 Intake
        if (outputs.A1_INTAKE) {
          const a1 = outputs.A1_INTAKE;
          html += `<details style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ“¥ A1 Intake</summary>
            <div style="padding:8px 16px;font-size:13px">
              <div><strong>RFP ID:</strong> ${a1.rfp_id || 'â€”'}</div>
              <div><strong>Title:</strong> ${a1.title || 'â€”'}</div>
              <div><strong>Pages:</strong> ${a1.page_count ?? 'â€”'} | <strong>Words:</strong> ${a1.word_count ?? 'â€”'}</div>
            </div></details>`;
        }
        // A2 Structuring
        if (outputs.A2_STRUCTURING) {
          const a2 = outputs.A2_STRUCTURING;
          const sections = a2.sections || [];
          html += `<details style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ“‘ A2 Structuring (${sections.length} sections, confidence: ${(a2.overall_confidence || 0).toFixed(2)})</summary>
            <div style="padding:8px 16px;font-size:13px">
              ${sections.map(s => `<div style="padding:4px 0"><span class="type-badge">${s.category}</span> <strong>${s.title}</strong> â€” ${s.content_summary || ''}</div>`).join('')}
            </div></details>`;
        }
        // A3 Go/No-Go
        if (outputs.A3_GO_NO_GO) {
          const a3 = outputs.A3_GO_NO_GO;
          const mappings = a3.requirement_mappings || [];
          const statusColors = { ALIGNS: '#22c55e', VIOLATES: '#ef4444', RISK: '#f97316', NO_MATCH: '#888' };
          html += `<details open style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ“Š A3 Go/No-Go â€” <span style="color:${a3.decision === 'GO' ? '#22c55e' : '#ef4444'}">${a3.decision || 'â€”'}</span></summary>
            <div style="padding:8px 16px;font-size:13px">
              <div style="display:flex;gap:16px;margin-bottom:12px">
                <div><strong>Strategic Fit:</strong> ${a3.strategic_fit_score ?? 'â€”'}/10</div>
                <div><strong>Technical:</strong> ${a3.technical_feasibility_score ?? 'â€”'}/10</div>
                <div><strong>Risk:</strong> ${a3.regulatory_risk_score ?? 'â€”'}/10</div>
              </div>
              <div style="margin-bottom:8px"><strong>Justification:</strong> ${a3.justification || 'â€”'}</div>
              ${a3.red_flags && a3.red_flags.length ? `<div style="margin-bottom:8px;color:#f97316"><strong>Red Flags:</strong> ${a3.red_flags.join(', ')}</div>` : ''}
              <div style="margin-bottom:4px"><strong>Requirements:</strong> ${a3.total_requirements || 0} total | âœ… ${a3.aligned_count || 0} aligned | âŒ ${a3.violated_count || 0} violated | âš ï¸ ${a3.risk_count || 0} risk | â“ ${a3.no_match_count || 0} unmatched</div>
              ${mappings.length ? `<table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:12px">
                <thead><tr style="border-bottom:1px solid var(--border);text-align:left">
                  <th style="padding:6px">Requirement</th><th style="padding:6px">Status</th><th style="padding:6px">Matched Policy</th><th style="padding:6px">Reasoning</th>
                </tr></thead>
                <tbody>${mappings.map(m => `<tr style="border-bottom:1px solid var(--border)">
                  <td style="padding:6px;max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${(m.requirement_text || '').replace(/"/g, '&quot;')}">${m.requirement_text || ''}</td>
                  <td style="padding:6px"><span style="color:${statusColors[m.mapping_status] || '#888'};font-weight:600">${m.mapping_status}</span></td>
                  <td style="padding:6px;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis">${m.matched_policy || 'â€”'}</td>
                  <td style="padding:6px;font-size:11px;color:var(--text-muted)">${m.reasoning || ''}</td>
                </tr>`).join('')}</tbody>
              </table>` : ''}
            </div></details>`;
        }
        // B1 Requirements Extraction
        if (outputs.B1_REQUIREMENTS_EXTRACTION) {
          const b1 = outputs.B1_REQUIREMENTS_EXTRACTION;
          const funcCount = b1.filter(r => r.classification === 'FUNCTIONAL').length;
          const nonFuncCount = b1.filter(r => r.classification === 'NON_FUNCTIONAL').length;
          html += `<details style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ” B1 Requirements Extraction (${b1.length} total)</summary>
            <div style="padding:8px 16px;font-size:13px">
              <div style="margin-bottom:8px"><strong>Classification:</strong> ${funcCount} Functional | ${nonFuncCount} Non-Functional</div>
              <div style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px">
                <table style="width:100%;border-collapse:collapse;font-size:12px">
                  <thead style="position:sticky;top:0;background:var(--bg-secondary)"><tr style="border-bottom:1px solid var(--border);text-align:left">
                    <th style="padding:6px">ID</th><th style="padding:6px">Type</th><th style="padding:6px">Class</th><th style="padding:6px">Requirement</th>
                  </tr></thead>
                  <tbody>${b1.map(r => `<tr style="border-bottom:1px solid var(--border)">
                    <td style="padding:6px;font-weight:600;color:var(--accent-light)">${r.requirement_id}</td>
                    <td style="padding:6px">${r.type}</td>
                    <td style="padding:6px"><span class="type-badge">${r.classification}</span></td>
                    <td style="padding:6px;max-width:300px">${r.text}</td>
                  </tr>`).join('')}</tbody>
                </table>
              </div>
            </div></details>`;
        }
        // B2 Requirements Validation
        if (outputs.B2_REQUIREMENTS_VALIDATION) {
          const b2 = outputs.B2_REQUIREMENTS_VALIDATION;
          const conf = b2.confidence_score || 0;
          const confColor = conf >= 0.8 ? '#10b981' : conf >= 0.6 ? '#f59e0b' : '#ef4444';
          const issues = b2.issues || [];
          html += `<details open style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ›¡ï¸ B2 Requirements Validation &mdash; <span style="color:${confColor}">${(conf * 100).toFixed(0)}% Confidence</span></summary>
            <div style="padding:8px 16px;font-size:13px">
              <div style="display:flex;gap:16px;margin-bottom:12px">
                <div><strong>Duplicates:</strong> ${b2.duplicate_count || 0}</div>
                <div><strong>Contradictions:</strong> ${b2.contradiction_count || 0}</div>
                <div><strong>Ambiguities:</strong> ${b2.ambiguity_count || 0}</div>
              </div>
              ${issues.length ? `<div style="margin-bottom:8px"><strong>Identified Issues:</strong></div>
              <ul style="margin:0 0 12px 20px;color:var(--text-secondary)">
                ${issues.map(i => `<li style="margin-bottom:4px"><strong>[${i.issue_type}]</strong> (${(i.requirement_ids || []).join(', ')}) ${i.description}</li>`).join('')}
              </ul>` : '<div style="margin-bottom:12px;color:var(--success)">âœ… No issues identified. Requirements are solid.</div>'}
            </div></details>`;
        }
        // Other agents â€” raw JSON
        for (const [key, val] of Object.entries(outputs)) {
          if (['A1_INTAKE', 'A2_STRUCTURING', 'A3_GO_NO_GO', 'B1_REQUIREMENTS_EXTRACTION', 'B2_REQUIREMENTS_VALIDATION'].includes(key)) continue;
          html += `<details style="margin-bottom:12px"><summary style="cursor:pointer;font-weight:600;padding:8px 0">ğŸ”§ ${key}</summary>
            <pre style="padding:12px;background:var(--surface-2);border-radius:8px;font-size:11px;overflow-x:auto;max-height:300px">${JSON.stringify(val, null, 2)}</pre></details>`;
        }
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div style="padding:16px;text-align:center;color:#ef4444">Failed to load agent outputs: ${e.message}</div>`;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  EXTRACTED REQUIREMENTS (B1/B2)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let currentRequirements = [];

    async function loadRequirements(rfpId) {
      const container = document.getElementById('reqsContainer');
      const stats = document.getElementById('reqsStats');
      const filterRow = document.getElementById('reqsFilterRow');
      const badge = document.getElementById('reqConfBadge');

      container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)"><span class="spinner"></span> Loading requirementsâ€¦</div>';
      document.getElementById('reqsHint').textContent = `Run: ${rfpId}`;
      stats.style.display = 'none';
      filterRow.style.display = 'none';
      badge.style.display = 'none';

      try {
        const data = await apiFetch(`/api/rfp/${rfpId}/requirements`);
        if (!data.available) {
          container.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">${data.message || 'No requirements data available.'}</div>`;
          return;
        }

        currentRequirements = data.requirements || [];
        const val = data.validation || {};

        if (!currentRequirements.length) {
          container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">No requirements extracted for this run.</div>';
          return;
        }

        // â”€â”€ Stats â”€â”€
        document.getElementById('reqTotal').textContent = data.total || 0;
        document.getElementById('reqFunctional').textContent = data.functional_count || 0;
        document.getElementById('reqNonFunctional').textContent = data.non_functional_count || 0;
        document.getElementById('reqDuplicates').textContent = val.duplicate_count || 0;
        document.getElementById('reqIssues').textContent = (val.contradiction_count || 0) + (val.ambiguity_count || 0);

        stats.style.display = 'block';
        filterRow.style.display = 'flex';

        // â”€â”€ Confidence Badge â”€â”€
        if (typeof val.confidence_score === 'number') {
          const conf = val.confidence_score;
          const confColor = conf >= 0.8 ? '#10b981' : conf >= 0.6 ? '#f59e0b' : '#ef4444';
          badge.textContent = `${(conf * 100).toFixed(0)}% Confidence`;
          badge.style.color = confColor;
          badge.style.borderColor = confColor;
          badge.style.background = `${confColor}15`;
          badge.style.display = 'inline-block';
        }

        renderRequirementsTable();

      } catch (e) {
        container.innerHTML = `<div style="padding:24px;text-align:center;color:#ef4444;font-size:13px">Failed to load requirements: ${e.message}</div>`;
      }
    }

    function renderRequirementsTable() {
      const classFilter = document.getElementById('reqClassFilter').value;
      const typeFilter = document.getElementById('reqTypeFilter').value;

      const filtered = currentRequirements.filter(r => {
        if (classFilter && r.classification !== classFilter) return false;
        if (typeFilter && r.type !== typeFilter) return false;
        return true;
      });

      document.getElementById('reqFilterCount').textContent = `${filtered.length} visible`;

      const container = document.getElementById('reqsContainer');

      if (!filtered.length) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px">No requirements match the current filters.</div>';
        return;
      }

      // Split into groups
      const functional = filtered.filter(r => (r.classification || '').toUpperCase() === 'FUNCTIONAL');
      const nonFunctional = filtered.filter(r => (r.classification || '').toUpperCase() === 'NON_FUNCTIONAL');
      const other = filtered.filter(r => !['FUNCTIONAL', 'NON_FUNCTIONAL'].includes((r.classification || '').toUpperCase()));

      function buildGroupRows(rows) {
        return rows.map(r => `
          <tr style="border-bottom:1px solid var(--border)">
            <td style="font-weight:600;font-size:11px;color:var(--accent-light);padding:8px">${r.requirement_id || 'â€”'}</td>
            <td style="padding:8px"><span style="font-size:11px;padding:2px 8px;border-radius:10px;background:${r.type === 'MANDATORY' ? 'rgba(239,68,68,0.12)' : 'rgba(107,114,128,0.12)'};color:${r.type === 'MANDATORY' ? '#ef4444' : '#9ca3af'};font-weight:600">${r.type}</span></td>
            <td style="max-width:400px;line-height:1.5;padding:8px;font-size:12px" title="${(r.text || '').replace(/"/g, '&quot;')}">${r.text || 'â€”'}</td>
          </tr>
        `).join('');
      }

      let html = '<div style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px">';
      html += '<table class="mapping-table" style="width:100%">';
      html += `<thead style="position:sticky;top:0;background:var(--bg-secondary);z-index:10">
        <tr>
          <th style="width:100px;padding:8px">ID</th>
          <th style="width:100px;padding:8px">Type</th>
          <th style="padding:8px">Requirement Text</th>
        </tr>
      </thead><tbody>`;

      // Functional group
      if (functional.length) {
        html += `<tr>
          <td colspan="3" style="padding:10px 8px;background:rgba(99,102,241,0.08);border-left:4px solid #6366f1;font-weight:700;font-size:13px;color:#818cf8">
            âš™ï¸ Functional Requirements
            <span style="margin-left:8px;font-size:11px;font-weight:500;padding:2px 10px;border-radius:12px;background:rgba(99,102,241,0.15);color:#a5b4fc">${functional.length}</span>
          </td>
        </tr>`;
        html += buildGroupRows(functional);
      }

      // Non-Functional group
      if (nonFunctional.length) {
        html += `<tr>
          <td colspan="3" style="padding:10px 8px;background:rgba(16,185,129,0.08);border-left:4px solid #10b981;font-weight:700;font-size:13px;color:#34d399">
            ğŸ“ Non-Functional Requirements
            <span style="margin-left:8px;font-size:11px;font-weight:500;padding:2px 10px;border-radius:12px;background:rgba(16,185,129,0.15);color:#6ee7b7">${nonFunctional.length}</span>
          </td>
        </tr>`;
        html += buildGroupRows(nonFunctional);
      }

      // Other/Unclassified group (if any)
      if (other.length) {
        html += `<tr>
          <td colspan="3" style="padding:10px 8px;background:rgba(107,114,128,0.08);border-left:4px solid #6b7280;font-weight:700;font-size:13px;color:#9ca3af">
            â“ Unclassified
            <span style="margin-left:8px;font-size:11px;font-weight:500;padding:2px 10px;border-radius:12px;background:rgba(107,114,128,0.15);color:#d1d5db">${other.length}</span>
          </td>
        </tr>`;
        html += buildGroupRows(other);
      }

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    document.getElementById('reqClassFilter').addEventListener('change', renderRequirementsTable);
    document.getElementById('reqTypeFilter').addEventListener('change', renderRequirementsTable);

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _healthInterval = null;
    let _statsInterval = null;

    function pausePolling() {
      if (_healthInterval) { clearInterval(_healthInterval); _healthInterval = null; }
      if (_statsInterval) { clearInterval(_statsInterval); _statsInterval = null; }
    }
    function resumePolling() {
      if (!_healthInterval) _healthInterval = setInterval(checkHealth, 60000);
      if (!_statsInterval) _statsInterval = setInterval(loadKBStats, 60000);
    }

    checkHealth();
    loadKBStats();
    loadKBFiles();
    loadRuns();
    loadPolicies();
    resumePolling();
  </script>
</body>

</html>